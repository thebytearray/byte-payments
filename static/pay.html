<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Payment - Byte Payments</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            neutral: {
                                50: '#fafafa',
                                100: '#f5f5f5',
                                200: '#e5e5e5',
                                300: '#d4d4d4',
                                400: '#a3a3a3',
                                500: '#737373',
                                600: '#525252',
                                700: '#404040',
                                800: '#262626',
                                900: '#171717',
                                950: '#0a0a0a',
                            }
                        }
                    }
                }
            }
        </script>
        <style>
            body {
                font-family: system-ui, -apple-system, sans-serif;
                transition: background-color 0.3s ease, color 0.3s ease;
            }
            .qr-container {
                background: white;
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            .dark .qr-container {
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            .address-container:hover {
                border-color: #3b82f6;
                background: #eff6ff;
            }
            .dark .address-container:hover {
                background: #1e3a8a;
            }
            .cancel-btn {
                transition: all 0.2s ease;
                border: 1px solid #e5e7eb;
            }
            .dark .cancel-btn {
                border-color: #404040;
            }
            .cancel-btn:hover {
                background: #f3f4f6;
                border-color: #d1d5db;
            }
            .dark .cancel-btn:hover {
                background: #404040;
                border-color: #525252;
            }
            .theme-toggle {
                transition: all 0.2s ease;
            }
        </style>
    </head>
    <body class="bg-neutral-50 dark:bg-neutral-950 flex items-center justify-center p-4 min-h-screen transition-colors">
        <div class="max-w-md w-full bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 shadow-sm overflow-hidden">
            <!-- Header -->
            <div class="bg-neutral-100 dark:bg-neutral-800 border-b border-neutral-200 dark:border-neutral-700 p-4">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100">Byte Payments</h1>
                        <p class="text-sm text-neutral-600 dark:text-neutral-400 mt-1">by The Byte Array</p>
                    </div>
                    <button
                        id="themeToggle"
                        class="theme-toggle p-2 rounded-lg bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-700 dark:text-neutral-300"
                        aria-label="Toggle theme"
                    >
                        <span id="themeIcon">🌙</span>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="p-6">
                <!-- Amount & Timer -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <p class="text-sm text-neutral-600 dark:text-neutral-400">Amount to pay</p>
                        <h2 class="text-2xl font-bold text-neutral-900 dark:text-neutral-100">
                            2,500 <span class="text-blue-600 dark:text-blue-400">TRX</span>
                        </h2>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-neutral-600 dark:text-neutral-400">Time remaining</p>
                        <div id="timer" class="text-lg font-semibold text-neutral-900 dark:text-neutral-100">
                            15:00
                        </div>
                    </div>
                </div>

                <!-- QR Code -->
                <div class="mb-6">
                    <div class="qr-container mx-auto w-48 h-48 flex items-center justify-center">
                        <img
                            id="qrCode"
                            src="https://www.formsite.com/wp-content/uploads/2018/09/qrcode-feature.svg"
                            alt="Payment QR Code"
                            class="w-40 h-40 object-contain cursor-pointer transition-transform hover:scale-105"
                        />
                    </div>
                    <p class="text-center text-xs text-neutral-500 dark:text-neutral-400 mt-2">Click QR code to copy address</p>
                </div>

                <!-- Payment Address -->
                <div class="mb-6">
                    <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-2 text-center">
                        Send exactly 2,500 TRX to
                    </p>
                    <div class="flex items-center justify-between bg-neutral-50 dark:bg-neutral-800 rounded-lg p-3 border border-neutral-200 dark:border-neutral-700 transition-all duration-200 address-container">
                        <div class="truncate text-sm font-mono text-neutral-800 dark:text-neutral-200" id="paymentAddress">
                            TJd34hR9gv9TbMqgXq7zL8Wm5kD2nB3vC4
                        </div>
                        <button
                            id="copyButton"
                            class="ml-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                        >
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="bg-neutral-50 dark:bg-neutral-800 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-neutral-600 dark:text-neutral-400">Currency</p>
                            <p class="font-medium text-blue-600 dark:text-blue-400">TRX (TRON)</p>
                        </div>
                        <div>
                            <p class="text-neutral-600 dark:text-neutral-400">Network</p>
                            <p class="font-medium text-neutral-900 dark:text-neutral-100">TRON</p>
                        </div>
                        <div>
                            <p class="text-neutral-600 dark:text-neutral-400">Payment ID</p>
                            <p class="font-mono text-xs truncate text-neutral-800 dark:text-neutral-200 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors" id="paymentIdDisplay" title="Click to copy">
                                TXID-7890-ABCD-1234-EFGH
                            </p>
                        </div>
                        <div>
                            <p class="text-neutral-600 dark:text-neutral-400">Status</p>
                            <p class="font-medium" id="paymentStatus">
                                <span class="text-amber-600 dark:text-amber-400">Awaiting Payment</span>
                            </p>
                            <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
                                Auto-refreshes every 10 seconds
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Cancel Button -->
                <div id="cancelButtonContainer">
                    <button
                        id="cancelButton"
                        class="w-full h-10 px-4 bg-white dark:bg-neutral-900 rounded-md font-medium text-sm cancel-btn flex items-center justify-center gap-2 text-neutral-700 dark:text-neutral-300"
                    >
                        Cancel Payment
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-neutral-100 dark:bg-neutral-800 border-t border-neutral-200 dark:border-neutral-700 p-3">
                <div class="flex items-center justify-center gap-4 text-xs text-neutral-500 dark:text-neutral-400">
                    <div class="flex items-center gap-1">
                        <span>Secure</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span>Fast</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span>Global</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div
            id="toast"
            class="fixed bottom-4 right-4 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 text-neutral-900 dark:text-neutral-100 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"
        >
            <div class="flex items-center gap-2">
                <span id="toastIcon" class="text-blue-600 dark:text-blue-400">ℹ</span>
                <span id="toastMessage">Address copied to clipboard!</span>
            </div>
        </div>

        <script>
            let timeLeft = 15 * 60;
            let timerInterval;
            let statusCheckInterval;
            let paymentData = null;
            let isDarkMode = false;
            let paymentCreatedAt = null;

            // Theme management
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');

            function initTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    isDarkMode = true;
                    themeIcon.textContent = '☀️';
                } else {
                    document.documentElement.classList.remove('dark');
                    isDarkMode = false;
                    themeIcon.textContent = '🌙';
                }
            }

            function toggleTheme() {
                isDarkMode = !isDarkMode;
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    themeIcon.textContent = '☀️';
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    themeIcon.textContent = '🌙';
                }
            }

            // DOM Elements
            const timerElement = document.getElementById("timer");
            const copyButton = document.getElementById("copyButton");
            const qrCode = document.getElementById("qrCode");
            const paymentAddress = document.getElementById("paymentAddress");
            const toast = document.getElementById("toast");
            const toastMessage = document.getElementById("toastMessage");
            const toastIcon = document.getElementById("toastIcon");
            const cancelButton = document.getElementById("cancelButton");
            const cancelButtonContainer = document.getElementById("cancelButtonContainer");
            const paymentStatusElement = document.getElementById("paymentStatus");
            const paymentIdDisplay = document.getElementById("paymentIdDisplay");


            // Get payment ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const currentPaymentId = urlParams.get('id');

            // Initialize page
            document.addEventListener('DOMContentLoaded', () => {
                initTheme();
                if (!currentPaymentId) {
                    showError();
                } else {
                    loadPaymentData();
                }
            });

            async function loadPaymentData() {
                try {
                    const response = await fetch(`/api/v1/payments/${currentPaymentId}/status`);
                    const data = await response.json();

                    if (data.status === 'ok' && data.data) {
                        paymentData = data.data;
                        paymentCreatedAt = data.data.created_at; // Store creation time
                        displayPaymentData();
                        startTimer();
                        startStatusChecking();
                    } else {
                        showError();
                    }
                } catch (error) {
                    console.error('Error loading payment data:', error);
                    showError();
                }
            }

            function displayPaymentData() {
                const amount = parseFloat(paymentData.trx_amount).toFixed(6);
                
                // Update amount displays
                const mainAmountElement = document.querySelector('h2');
                if (mainAmountElement && mainAmountElement.textContent.includes('2,500')) {
                    mainAmountElement.innerHTML = `${amount} <span class="text-blue-600 dark:text-blue-400">TRX</span>`;
                }

                const paragraphs = document.querySelectorAll('p');
                paragraphs.forEach(p => {
                    if (p.textContent.includes('Send exactly 2,500')) {
                        p.innerHTML = `Send exactly ${amount} TRX to`;
                    }
                });

                // Set payment address
                paymentAddress.textContent = paymentData.trx_wallet_address;

                // Set QR code
                qrCode.src = paymentData.qr_image;

                // Update payment ID
                paymentIdDisplay.textContent = paymentData.payment_id;

                // Set initial status
                updateStatus(paymentData.status);
            }

            function updateStatus(status) {
                const paragraphs = document.querySelectorAll('p');
                let statusElement = null;
                
                paragraphs.forEach(p => {
                    if (p.textContent.includes('Awaiting Payment') || p.classList.contains('font-medium')) {
                        const parent = p.parentElement;
                        if (parent && parent.querySelector('p.text-neutral-600') && parent.querySelector('p.text-neutral-600').textContent === 'Status') {
                            statusElement = p;
                        }
                    }
                });

                if (!statusElement) return;

                switch (status.toLowerCase()) {
                    case 'pending':
                        statusElement.innerHTML = '<span class="text-amber-600 dark:text-amber-400">Awaiting Payment</span>';
                        break;
                    case 'completed':
                        statusElement.innerHTML = '<span class="text-green-600 dark:text-green-400">Payment Completed</span>';
                        clearInterval(timerInterval);
                        clearInterval(statusCheckInterval);
                        showToast('Payment completed successfully!', 'success');
                        // Hide cancel button
                        cancelButtonContainer.style.display = 'none';
                        // Update refresh indicator
                        const completedIndicator = statusElement.parentElement.querySelector('p.text-xs');
                        if (completedIndicator) {
                            completedIndicator.innerHTML = 'Payment confirmed';
                        }
                        break;
                    case 'cancelled':
                        statusElement.innerHTML = '<span class="text-red-600 dark:text-red-400">Payment Cancelled</span>';
                        clearInterval(timerInterval);
                        clearInterval(statusCheckInterval);
                        // Hide cancel button
                        cancelButtonContainer.style.display = 'none';
                        // Update refresh indicator
                        const cancelledIndicator = statusElement.parentElement.querySelector('p.text-xs');
                        if (cancelledIndicator) {
                            cancelledIndicator.innerHTML = 'Payment cancelled';
                        }
                        break;
                    case 'expired':
                        statusElement.innerHTML = '<span class="text-red-600 dark:text-red-400">Payment Expired</span>';
                        clearInterval(timerInterval);
                        clearInterval(statusCheckInterval);
                        // Hide cancel button
                        cancelButtonContainer.style.display = 'none';
                        // Update refresh indicator
                        const expiredIndicator = statusElement.parentElement.querySelector('p.text-xs');
                        if (expiredIndicator) {
                            expiredIndicator.innerHTML = 'Payment expired';
                        }
                        break;
                }
            }

            function showError() {
                document.body.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen p-4 bg-neutral-50 dark:bg-neutral-950">
                        <div class="text-center bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-8 max-w-md shadow-lg">
                            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-red-600 dark:text-red-400 text-2xl font-bold">!</span>
                            </div>
                            <h2 class="text-xl font-bold text-neutral-900 dark:text-neutral-100 mb-2">Payment Not Found</h2>
                            <p class="text-neutral-600 dark:text-neutral-400 mb-6">The payment you're looking for doesn't exist or has expired. Please create a new payment.</p>
                            <div class="space-y-3">
                                <button
                                    onclick="window.location.href='/plans'"
                                    class="w-full bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-md font-medium text-white transition-colors"
                                >
                                    Select New Plan
                                </button>
                                <button
                                    onclick="window.history.back()"
                                    class="w-full bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 px-6 py-3 rounded-md font-medium text-neutral-700 dark:text-neutral-300 transition-colors"
                                >
                                    Go Back
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function startTimer() {
                function updateTimer() {
                    if (!paymentCreatedAt) return; // Ensure paymentCreatedAt is set

                    const paymentTime = new Date(paymentCreatedAt).getTime();
                    const currentTime = new Date().getTime();
                    const timeDifference = currentTime - paymentTime;

                    timeLeft = Math.max(0, Math.floor((15 * 60 * 1000 - timeDifference) / 1000));

                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `${minutes.toString().padStart(2, "0")}:${seconds
                        .toString()
                        .padStart(2, "0")}`;

                    if (timeLeft < 300) {
                        timerElement.classList.add("text-amber-600");
                    }
                    if (timeLeft < 60) {
                        timerElement.classList.remove("text-amber-600");
                        timerElement.classList.add("text-red-600");
                    }

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        timerElement.textContent = "00:00";
                        timerElement.classList.add("text-red-600");
                        showToast("Payment time has expired!", 'error');
                        updateStatus('expired');
                    }
                }

                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            }

            function startStatusChecking() {
                statusCheckInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/api/v1/payments/${currentPaymentId}/status`);
                        const data = await response.json();

                        if (data.status === 'ok' && data.data) {
                            updateStatus(data.data.status);
                            
                            if (['completed', 'cancelled', 'expired'].includes(data.data.status.toLowerCase())) {
                                clearInterval(statusCheckInterval);
                            }
                        }
                    } catch (error) {
                        console.error('Error checking payment status:', error);
                    }
                }, 10000);
            }

            function copyToClipboard() {
                navigator.clipboard
                    .writeText(paymentAddress.textContent)
                    .then(() => {
                        showToast("Address copied to clipboard!", 'success');
                        copyButton.textContent = 'Copied';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy';
                        }, 2000);
                    })
                    .catch((err) => {
                        showToast("Failed to copy address!", 'error');
                        console.error("Could not copy text: ", err);
                    });
            }

            async function cancelPayment() {
                if (!confirm("Are you sure you want to cancel this payment?")) return;

                try {
                    const response = await fetch(`/api/v1/payments/${currentPaymentId}/cancel`, {
                        method: 'PATCH'
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'ok') {
                        showToast("Payment cancelled successfully", 'success');
                        updateStatus('cancelled');
                    } else {
                        showToast(data.message || "Failed to cancel payment", 'error');
                    }
                } catch (error) {
                    console.error('Error cancelling payment:', error);
                    showToast("Failed to cancel payment", 'error');
                }
            }

            function showToast(message, type = 'info') {
                const icons = {
                    success: '✓',
                    error: '✗',
                    info: 'ℹ'
                };

                toastIcon.textContent = icons[type] || icons.info;
                toastMessage.textContent = message;
                toast.classList.remove("translate-y-20", "opacity-0");
                toast.classList.add("translate-y-0", "opacity-100");
                setTimeout(() => {
                    toast.classList.remove("translate-y-0", "opacity-100");
                    toast.classList.add("translate-y-20", "opacity-0");
                }, 3000);
            }

            // Event listeners
            copyButton.addEventListener("click", copyToClipboard);
            qrCode.addEventListener("click", copyToClipboard);
            cancelButton.addEventListener("click", cancelPayment);
            themeToggle.addEventListener("click", toggleTheme);
            paymentIdDisplay.addEventListener("click", () => {
                navigator.clipboard.writeText(paymentIdDisplay.textContent).then(() => {
                    showToast("Payment ID copied to clipboard!", 'success');
                }).catch(err => {
                    showToast("Failed to copy payment ID!", 'error');
                    console.error("Could not copy text: ", err);
                });
            });

            // Cleanup intervals when page is unloaded
            window.addEventListener('beforeunload', () => {
                if (timerInterval) clearInterval(timerInterval);
                if (statusCheckInterval) clearInterval(statusCheckInterval);
            });
        </script>
    </body>
</html>